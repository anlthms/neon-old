#!/usr/bin/env python
# ----------------------------------------------------------------------------
# Copyright 2014 Nervana Systems Inc.  All rights reserved.
# ----------------------------------------------------------------------------
"""
Shell script to control spearmint runs
"""

import argparse
import os, sys
from ipdb import set_trace as trace


def parse_args():
    """
    Sets up and handles command line argument parsing.
    """
    parser = argparse.ArgumentParser(description='run spearmint hyperoptimize')
    parser.add_argument('cmd', type=str,  action='store', default='def',
                        help='init, run or reset ')
    parser.add_argument('-p', '--port', type=int, action='store', default=5000)
    return parser.parse_args()

def main():
    """
    Point of code entry.
    """
    argz = parse_args()
    if (argz.cmd == 'reset'):
        os.system('../spearmint/spearmint/bin/cleanup neon/spearmint  &&'
                  "rm neon/spearmint/yamels/*.yaml")
        print("Running cleanup")
    if (argz.cmd == 'run'):
        os.system('cd neon/spearmint && pwd && '
                  + '../../../spearmint/spearmint/bin/spearmint '
                  + 'spear_config.pb '
                  + '--driver=local --method=GPEIperSecChooser '
                  + '--method-args=noiseless=0 --polling-time=20 '
                  + '--max-concurrent=2 -w --port=' + str(argz.port) )
    if (argz.cmd == 'init'):
        os.system('python neon/spearmint/spear_writer.py')

if __name__ == '__main__':
    result = main()
    sys.exit(result)
